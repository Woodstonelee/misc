% test pulse filtering algorithm
% observe the correlation between DWEL's asymmetric pulses
% Zhan Li, zhanli86@bu.edu
% Created: 20140709

clear;

pulse1064 = [ ...
-0.002732,-0.005479,0.001389,-0.004083,-0.002710,0.004155,0.001400,0.012378,0.004147,0.000023, ...
0.004140,-0.005457,0.001381,-0.013695,-0.009589,-0.008215,-0.006846,0.012359,0.001404,0.016472, ...
0.012366,0.015102,0.016476,0.000026,0.006868,-0.012310,-0.001347,-0.005453,-0.012302,0.000030, ...
-0.009555,0.008261,0.005532,0.008246,0.015099,0.005498,0.017820,0.008242,0.008230,0.001392, ...
0.006887,0.008246,0.002777,0.006864,0.008242,0.009600,0.013714,0.008238,0.009608,0.009619, ...
0.004136,0.006891,0.004151,0.005506,-0.004098,0.001381,0.015106,0.008249,0.015102,0.012374, ...
0.015117,0.015121,0.000038,0.005510,-0.005461,-0.001362,0.000004,-0.002740,0.012344,0.001396, ...
0.023337,0.038446,0.100184,0.211309,0.355359,0.547392,0.707892,0.868358,0.971210,1.000000, ...
0.945089,0.791457,0.604862,0.357963,0.124774,-0.067259,-0.238699,-0.340212,-0.393666,-0.388179, ...
-0.331925,-0.246861,-0.127544,-0.028763,0.065859,0.126216,0.165983,0.183814,0.174213,0.149515, ...
0.115234,0.074070,0.041152,0.000011,-0.020574,-0.035654,-0.052115,-0.042503,-0.042503,-0.026042, ...
-0.020548,-0.009582,0.010981,0.008242,0.030171,0.024691,0.038398,0.037028,0.030178,0.039771, ...
0.021955,0.026061,0.006864,0.008230,0.008230,-0.005472,0.009593,-0.004102,0.004113,0.008238, ...
0.010985,0.026061,0.012370,0.021955,0.017853,0.013729,0.016457,0.009608,0.013699,0.006857, ...
0.009589,0.013717,0.009600,0.010970,0.008234,0.010978,0.010985,0.005502,0.010981,0.009612, ...
0.016468,0.017838,0.017838,0.028816,0.023325,0.024688,0.024684,0.016450,0.019189];

pnorm = sum(pulse1064);
plen = length(pulse1064);
wf = [zeros(1, fix(plen/2)), pulse1064, zeros(1, fix(plen/2))] * 5;
wflen = length(wf);
b = zeros(1, wflen);
r = zeros(1, wflen);
figure();
plot(wf, '.'); 
hold on;
plot(fix(plen/2)+1:wflen-fix(plen/2), wf(fix(plen/2)+1:wflen-fix(plen/2)), '.r');
for t = fix(plen/2) : wflen-fix(plen/2)-1
    wfseg = wf(t-fix(plen/2)+1:t-fix(plen/2)+plen);
    b(t) = sum(wfseg.*pulse1064) / pnorm;
    r(t) = b(t) * sqrt(mean(pulse1064.^2)) ./ sqrt(mean(wfseg.^2));
    plot(t, b(t), '.g')
    plot(t, r(t), '.y')
end
plot(138-80+1:138+80-1, pulse1064, '.k')
line([138,138], [0, 1])
plot(178-80+1:178+80-1, pulse1064, '.c')
line([178,178], [0, 1])

% observe the correlation of symmetric auto-correlation of the original pulse
b = b(fix(plen/2) : wflen-fix(plen/2)-1);
newb = xcorr(b, b)/sum(b);
figure(); plot(newb); hold on; plot(159-80+1:159+80-1, b, 'r')

