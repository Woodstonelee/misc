%% Analysis of cal_nsf_20140812 wire returns at 1064 nm
% Wire returns are from stationary scans. Stationary scans were converted to
% fake data cube and went through all DWEL2.0 processing steps that are
% adapted to accomodate stationary scans without lambertian panels. The
% intensity is not scaled with mean casing intensity since stationary scans
% don't have casing returns. But the background noise removal, pulse
% filtering and point cloud generation are the same and pose the same effect
% on intensity alteration. The wire was at position in stationary scans. The
% interpolated wire return peaks are output here after filtered re-fixing
% processing. 
% 
% The purpose of checking out wire returns is to monitor outgoing laser
% energy change with wire returns when we don't have lambertian panel returns
% in the stationary scans. 
%
% Zhan Li, zhanli86@bu.edu
% Created: 20141105
% Last modified: 20141105


% ******************************************************************************
indir = ['/projectnb/echidna/lidar/DWEL_Processing/DWEL_TestCal/cal-nsf-' ...
         '20140812/cal-nsf-20140812-wire-returns-summary'];

infiles = { ...
'cal_nsf_20140812_0.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_1.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_10_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_11_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_12_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_13_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_14_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_15_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_1_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_2.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_20_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_25_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_2_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_3.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_30_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_35_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_3_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_4.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_40_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_4_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_5.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_50_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_6.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_60_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_6_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_7.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_70_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_7_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_8.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_8_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_9.5_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
'cal_nsf_20140812_9_1064_cube_bsfix_pxc_update_filtfix_wire.log', ...
};

timebin = 0.1; % ns
dnbin = 1; % dn

% ******************************************************************************

numfiles = length(infiles);

fnum = 18;

filename = fullfile(indir, infiles{fnum});
fid = fopen(filename, 'r');
data = textscan(fid, repmat('%f', 1, 7), 'HeaderLines', 2, 'Delimiter', ',');
fclose(fid);
data = cell2mat(data);

% get the range from the file name
tmpstr = strsplit(infiles{fnum}, '_');
panelrange = str2num(tmpstr{4});
fprintf('panel at %f m\n', panelrange);

figh = figure('Name', ['Stats of wire signals at ', num2str(panelrange), ' ' ...
                    'm']);
subplot(2,1,1);
hist(data(:,1), min(data(:,1)):timebin:max(data(:,2)));
xlabel('Tzero location from the wire, ns');
ylabel('frequency');
subplot(2,1,2);
hist(data(:,2), min(data(:,2)):dnbin:max(data(:,2)));
xlabel('Wire intensity, dn after background base removal');
ylabel('frequency');
saveas(figh, [filename(1:end-4), '.fig']);
print(figh, [filename(1:end-4), '.png'], '-dpng','-r300','-painters');
%close(figh);
figure('Name', 'Wire intensity change');
plot(data(:,2), '.');
figure();
plot(data(:,1), data(:,2), '.')