%% Compare ranges to the same target extracted from 1064 and 1548
%% waveforms. 
% Extract ranges to panels placed at different locations from
% dual-wavelength waveforms. Check the difference/error between
% ranges from waveforms at the two wavelengths. 
% The smaller the difference is, the better. Also regress between
% these ranges from the two wavelengths to see if there is any
% systematic difference. This will decide whether a single point
% cloud can be generated from two point clouds at the two
% wavelengths simply by averaging point coordinates. 
% 
% Zhan Li, zhanli86@bu.edu
% Created, 20140113
% Last modified, 20140113

% ******************************************************************************
% some input parameters
refineddatadir = '/projectnb/echidna/lidar/DWEL_Processing/DWEL_TestCal/cal-nsf-20140812/cal-nsf-20140812-wire-removed-panel-returns-summary/cal-nsf-20140812-wire-removed-panel-returns-refined-summary';;
refined1064files = { ...
'cal_nsf_20140812_0.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_1.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_10_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_11_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_12_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_13_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_14_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_15_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_1_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_2.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_20_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_25_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_2_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_3.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_30_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_35_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_3_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_4.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_40_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_4_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_5.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_50_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_6.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_60_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_6_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_7.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_70_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_7_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_8.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_8_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_9.5_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_9_1064_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
};
refined1548files = { ...
'cal_nsf_20140812_0.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_1.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_10_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_11_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_12_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_13_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_14_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_15_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_1_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_2.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_20_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_25_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_2_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_3.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_30_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_35_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_3_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_4.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_40_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_4_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_5.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_50_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_6.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_60_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_6_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_7.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_70_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_7_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_8.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_8_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_9.5_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
'cal_nsf_20140812_9_1548_cube_bsfix_pxc_update_ptcl_points_panel_returns_refined.txt'...
};

% mean range data file
refinedmean1064file = 'cal_nsf_20140812_wire_removed_panel_returns_refined_stats_1064_for_calest.txt';
refinedmean1548file = 'cal_nsf_20140812_wire_removed_panel_returns_refined_stats_1548_for_calest.txt';
% ******************************************************************************

%% Compare mean ranges from the two wavelengths
fid = fopen(fullfile(refineddatadir, refinedmean1064file), 'r');
data = textscan(fid, repmat('%f', 1, 15), 'HeaderLines', 1, 'Delimiter', ',');
fclose(fid);
data = cell2mat(data);
meanrange1064 = data(:, 1:3);

fid = fopen(fullfile(refineddatadir, refinedmean1548file), 'r');
data = textscan(fid, repmat('%f', 1, 15), 'HeaderLines', 1, 'Delimiter', ',');
fclose(fid);
data = cell2mat(data);
meanrange1548 = data(:, 1:3);

tmpflag = meanrange1064~=0 & meanrange1548~=0;
% linear regression between ranges at the two wavelengths.
p = polyfit(meanrange1064(tmpflag), meanrange1548(tmpflag), 1);
r2 = rsquare(meanrange1064(tmpflag), polyval(p, meanrange1064(tmpflag)));
% plot scatter plot of mean ranges at the two wavelengths
figure('Name', 'Mean ranges 1064 vs 1548');
plot(meanrange1064(tmpflag), meanrange1548(tmpflag), '.b');
hold on;
plot([min(meanrange1064(tmpflag)), max(meanrange1064(tmpflag))], ...
     polyval(p, [min(meanrange1064(tmpflag)), ...
                 max(meanrange1064(tmpflag))]), '-b');
plot([min(meanrange1064(tmpflag)), max(meanrange1064(tmpflag))], ...
     [min(meanrange1064(tmpflag)), ...
                 max(meanrange1064(tmpflag))], '-k');
xlabel('mean range from 1064 nm');
ylabel('mean range from 1548 nm');
axis equal;


%% Compare all ranges before averaging from the same waveform at
%% the two wavelengths. 
range1064 = [];
range1548 = [];
meanrangediff = [];
meanrangedual = [];
for f=1:length(refined1064files)
    if ~exist(fullfile(refineddatadir, refined1064files{f})) || ...
            ~exist(fullfile(refineddatadir, refined1548files{f}))
        continue;
    end
    fid = fopen(fullfile(refineddatadir, refined1064files{f}), ...
                'r');
    data = textscan(fid, repmat('%f', 1, 12), 'HeaderLines', 1, 'Delimiter', ',');
    fclose(fid);
    data = cell2mat(data);
    tmpflag = data(:, 9)==0 & data(:, 12)==1;
    tmp1064 = data(tmpflag, :);

    fid = fopen(fullfile(refineddatadir, refined1548files{f}), ...
                'r');
    data = textscan(fid, repmat('%f', 1, 12), 'HeaderLines', 1, 'Delimiter', ',');
    fclose(fid);
    data = cell2mat(data);
    tmpflag = data(:, 9)==0 & data(:, 12)==1;
    tmp1548 = data(tmpflag, :);

    [~, i1064, i1548] = intersect(tmp1064(:,1), tmp1548(:,1));
    if length(i1064) < 100 
        continue;
    end

    % save histogram figure of range difference at this range
    % location. 
    figh = figure('Visible', 'Off');
    [freq, tmpx] = hist(tmp1064(i1064, 4)-tmp1548(i1548, 4), -0.4:0.8/ ...
                  2000:0.4);
    bar(tmpx, freq/sum(freq));
    xlabel('range difference, meter');
    ylabel('probability');
    title(sprintf('Range difference at %.3f meter', mean((tmp1064(i1064, 4)+tmp1548(i1548, 4))/2)));
    export_fig(sprintf('hist_range_diff_dual_wl_20140812_%.1f.png', mean((tmp1064(i1064, 4)+tmp1548(i1548, 4))/2)), ...
               '-r300', '-png', '-painters');
    close(figh);

    meanrangediff = [meanrangediff; mean(tmp1064(i1064, 4)-tmp1548(i1548, 4))];
    meanrangedual = [meanrangedual; mean((tmp1064(i1064, 4)+tmp1548(i1548, 4))/2)];

    range1064 = [range1064; tmp1064(i1064, 4)];
    range1548 = [range1548; tmp1548(i1548, 4)];
end

% linear regression
p = polyfit(range1064, range1548, 1);
r2 = rsquare(range1064, polyval(p, range1064));
% scatter plot
figure('Name', 'All ranges, 1064 vs 1548');
plot(range1064, range1548, '.b');
hold on;
plot([min(range1064), max(range1064)], polyval(p, [min(range1064), ...
                    max(range1064)]), '-b')
plot([min(range1064), max(range1064)], [min(range1064), max(range1064)], ...
     '-k');
axis equal;
xlabel('ranges, 1064 nm');
ylabel('ranges, 1548 nm');

% calculate the difference between ranges from the two wavelengths
% plot the histogram
figure('Name', ['Histogram of range difference between 1064 and ' ...
                '1548']);
[f, x]=hist((range1064-range1548), 2000);
bar(x, f./sum(f));
xlabel('range difference, meter');
ylabel('probability');
export_fig('hist_range_diff_dual_wl_20140812.png', '-r300', '-png', '-painters');